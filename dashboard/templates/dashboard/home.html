<!DOCTYPE html>
<html>
<head>
    <title>KrishiShakti Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f9f0; padding: 20px; }
        h1 { color: green; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
        <h1>üå± KrishiShakti Dashboard</h1>
        {% if farmer_name and farmer_location %}
        <div class="mb-3 fs-5 text-dark">
            üë®‚Äçüåæ <b>{{ farmer_name }}</b> &mdash; <span class="text-success">{{ farmer_location }}</span>
        </div>
        {% endif %}

        <!-- Cards for latest N, P, K, pH -->
        {% if readings %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Nitrogen</h5>
                        <p class="card-text fs-4">{{ readings.0.nitrogen|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Phosphorus</h5>
                        <p class="card-text fs-4">{{ readings.0.phosphorus|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Potassium</h5>
                        <p class="card-text fs-4">{{ readings.0.potassium|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">pH</h5>
                        <p class="card-text fs-4">{{ readings.0.ph|floatformat:2 }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <button id="generate-reading-btn" style="background:#388e3c; color:white; border:none; padding:10px 20px; border-radius:6px; margin-bottom:20px; cursor:pointer;">Generate New Sensor Reading</button>
        <script>
        document.getElementById('generate-reading-btn').onclick = function() {
            fetch('/generate-reading/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    alert('New sensor reading generated!');
                    location.reload();
                }
            });
        };
        </script>
        {% if farmer_name and farmer_location %}
        <div style="margin-bottom:15px; font-size:18px; color:#333;">
            üë®‚Äçüåæ <b>{{ farmer_name }}</b> &mdash; <span style="color:#388e3c;">{{ farmer_location }}</span>
        </div>
        {% endif %}
            <div id="weather-card" style="display:none; margin-bottom:20px;">
                    <h2 style="color:#1565c0;">‚òÅÔ∏è Latest Weather Info</h2>
                    <div id="weather-content" style="font-size:16px; background:#e3f2fd; padding:10px; border-radius:8px;"></div>
            </div>
            <div id="recommendation-card" style="display:none; margin-bottom:20px;">
                    <h2 style="color:#2e7d32;">üåæ Fertilizer Recommendation</h2>
                    <div id="recommendation-content" style="font-size:18px; background:#e8f5e9; padding:10px; border-radius:8px;"></div>
            </div>
            <script>
            fetch('/api/weather/')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('weather-content').innerHTML =
                            `<b>Temperature:</b> ${data.temperature}¬∞C<br>` +
                            `<b>Humidity:</b> ${data.humidity}%<br>` +
                            `<b>Rainfall Probability:</b> ${data.rainfall_probability}%`;
                        document.getElementById('weather-card').style.display = 'block';
                    }
                });
            fetch('/api/recommendation/')
                .then(response => response.json())
                .then(data => {
                    if (data.recommendation) {
                        document.getElementById('recommendation-content').innerText = data.recommendation;
                        document.getElementById('recommendation-card').style.display = 'block';
                    }
                });
            </script>
    <table>
        <tr>
            <th>Timestamp</th>
            <th>Nitrogen</th>
            <th>Phosphorus</th>
            <th>Potassium</th>
            <th>pH</th>
        </tr>
        {% for r in readings %}
        <tr>
            <td>{{ r.timestamp }}</td>
            <td>{{ r.nitrogen|floatformat:2 }}</td>
            <td>{{ r.phosphorus|floatformat:2 }}</td>
            <td>{{ r.potassium|floatformat:2 }}</td>
            <td>{{ r.ph|floatformat:2 }}</td>
        </tr>
        {% endfor %}
    </table>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div style="max-width:800px; margin:30px auto;">
        <canvas id="npkChart"></canvas>
    </div>
    <div style="max-width:800px; margin:30px auto;">
        <canvas id="phChart"></canvas>
    </div>
    <script>
    // Prepare data for charts
    const timestamps = [{% for r in readings %}'{{ r.timestamp|date:"Y-m-d H:i" }}',{% endfor %}];
    const nitrogen = [{% for r in readings %}{{ r.nitrogen|floatformat:2 }},{% endfor %}];
    const phosphorus = [{% for r in readings %}{{ r.phosphorus|floatformat:2 }},{% endfor %}];
    const potassium = [{% for r in readings %}{{ r.potassium|floatformat:2 }},{% endfor %}];
    const ph = [{% for r in readings %}{{ r.ph|floatformat:2 }},{% endfor %}];

    // NPK Chart
    new Chart(document.getElementById('npkChart'), {
        type: 'line',
        data: {
            labels: timestamps,
            datasets: [
                { label: 'Nitrogen', data: nitrogen, borderColor: '#388e3c', fill: false },
                { label: 'Phosphorus', data: phosphorus, borderColor: '#1976d2', fill: false },
                { label: 'Potassium', data: potassium, borderColor: '#fbc02d', fill: false }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { title: { display: true, text: 'Timestamp' } }, y: { title: { display: true, text: 'Value' } } }
        }
    });

    // pH Chart
    new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: {
            labels: timestamps,
            datasets: [
                { label: 'pH', data: ph, borderColor: '#8e24aa', fill: false }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { x: { title: { display: true, text: 'Timestamp' } }, y: { title: { display: true, text: 'pH Level' }, min: 4, max: 9 } }
        }
    });
    </script>



</body>
</html>
